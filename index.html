<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Каталог деталей крана КС-8165 — демо-версия</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      background-color: #f5f5f5;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    header {
      background: #343a40;
      color: #fff;
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
    }

    header h1 {
      font-size: 1.25rem;
      margin: 0;
    }

    .tree-panel,
    .product-panel,
    .cart-panel {
      background: #fff;
      border-radius: 0.25rem;
      padding: 0.75rem;
      box-shadow: 0 0.1rem 0.25rem rgba(0, 0, 0, 0.08);
      min-height: 200px;
    }

    .tree {
      list-style: none;
      padding-left: 0;
      margin-bottom: 0;
    }

    .tree li {
      margin-bottom: 0.15rem;
    }

    .tree-item {
      display: flex;
      align-items: center;
      cursor: pointer;
      padding: 0.1rem 0.25rem;
      border-radius: 0.2rem;
    }

    .tree-item:hover {
      background-color: #f1f5ff;
    }

    .tree-item.active {
      background-color: #e0f2ff;
    }

    .tree-toggle {
      display: inline-block;
      width: 1.4rem;
      text-align: center;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
    }

    .tree-title {
      flex: 1;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .badge-type {
      font-size: 0.7rem;
    }

    .tree-children {
      list-style: none;
      padding-left: 1.25rem;
      margin-top: 0.1rem;
    }

    .small-muted {
      font-size: 0.85rem;
      color: #666;
    }

    .product-label {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .product-value {
      font-size: 0.9rem;
    }

    .product-image {
      max-height: 200px;
      object-fit: contain;
    }
  </style>
</head>
<body>

<header>
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1>Каталог деталей крана КС-8165 <span class="text-secondary">— демо-версия</span></h1>
    </div>
    <div class="text-end small text-light">
      Режим просмотра (редактирование доступно только локально)
    </div>
  </div>
</header>

<div class="container-fluid">
  <div class="row g-3">

    <!-- ЛЕВАЯ ПАНЕЛЬ: дерево изделий -->
    <div class="col-12 col-lg-3">
      <div class="tree-panel">
        <div class="mb-2 small">
          Дерево: <strong>сборки → детали → стандартизированные позиции.</strong>
        </div>
        <div id="treeError" class="text-danger small mb-2" style="display:none;"></div>
        <ul id="productsTree" class="tree">
          <li class="text-muted">Загрузка...</li>
        </ul>
      </div>
    </div>

    <!-- СРЕДНЯЯ ПАНЕЛЬ: карточка изделия -->
    <div class="col-12 col-lg-6">
      <div class="product-panel">
        <h5 class="mb-3">Карточка изделия</h5>

        <div id="productHint" class="small-muted mb-2">
          Выберите изделие в дереве слева.
        </div>
        <div id="productError" class="text-danger small mb-2" style="display:none;"></div>

        <div id="productCard" style="display:none;">
          <div class="row g-2 mb-2">
            <div class="col-md-4">
              <div class="product-label">Код</div>
              <div id="pCode" class="product-value"></div>
            </div>
            <div class="col-md-8">
              <div class="product-label">Наименование</div>
              <div id="pName" class="product-value"></div>
            </div>
          </div>

          <div class="row g-2 mb-2">
            <div class="col-md-4">
              <div class="product-label">Тип</div>
              <div id="pType" class="product-value"></div>
            </div>
            <div class="col-md-4">
              <div class="product-label">Масса, кг</div>
              <div id="pMass" class="product-value"></div>
            </div>
            <div class="col-md-4">
              <div class="product-label">Высота, мм</div>
              <div id="pHeight" class="product-value"></div>
            </div>
          </div>

          <div class="row g-2 mb-2">
            <div class="col-md-4">
              <div class="product-label">Длина, мм</div>
              <div id="pLength" class="product-value"></div>
            </div>
            <div class="col-md-4">
              <div class="product-label">Ширина, мм</div>
              <div id="pWidth" class="product-value"></div>
            </div>
            <div class="col-md-4">
              <div class="product-label">Объём, л (расч.)</div>
              <div id="pVolume" class="product-value"></div>
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <div class="product-label mb-1">2D-изображение</div>
              <div id="pImage2DContainer">
                <div class="small-muted">Не загружено.</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="product-label mb-1">3D-модель</div>
              <div id="pModel3DContainer">
                <div class="small-muted">Не загружена.</div>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-end mb-3">
            <button id="btnAddCurrentToCart" class="btn btn-outline-primary btn-sm">
              Добавить в корзину
            </button>
          </div>

          <h6 class="mt-3 mb-2">Состав сборки</h6>
          <div class="small-muted mb-1">
            Для деталей/стандарта состав пуст.
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light">
              <tr>
                <th style="width: 12%">Код</th>
                <th>Наименование</th>
                <th style="width: 10%">Кол-во</th>
                <th style="width: 12%">Тип</th>
                <th style="width: 12%">В корзину</th>
              </tr>
              </thead>
              <tbody id="bomBody">
              <tr><td colspan="5" class="text-muted small">Выберите сборку в дереве слева.</td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>

    <!-- ПРАВАЯ ПАНЕЛЬ: корзина -->
    <div class="col-12 col-lg-3">
      <div class="cart-panel">
        <h5 class="mb-3">Корзина</h5>
        <div class="small-muted mb-1">
          Состав заказа по позициям.
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-1">
            <thead class="table-light">
            <tr>
              <th style="width: 25%">Код</th>
              <th>Наименование</th>
              <th style="width: 15%">Кол-во</th>
              <th style="width: 10%">×</th>
            </tr>
            </thead>
            <tbody id="cartBody">
            <tr><td colspan="4" class="text-muted small text-center">Корзина пуста.</td></tr>
            </tbody>
          </table>
        </div>

        <div class="small mb-2">
          Суммарный объём корзины:
          <strong><span id="cartVolume">0.000</span> л</strong>
        </div>

        <button id="cartClear" class="btn btn-outline-danger btn-sm w-100 mb-3">
          Очистить корзину
        </button>

        <div class="mb-2">
          <label class="form-label form-label-sm mb-1">Заказчик</label>
          <input id="orderCustomer" class="form-control form-control-sm" placeholder="ФИО или организация" />
        </div>
        <div class="mb-2">
          <label class="form-label form-label-sm mb-1">Контакты</label>
          <input id="orderContacts" class="form-control form-control-sm" placeholder="телефон или email" />
        </div>
        <div class="mb-2">
          <label class="form-label form-label-sm mb-1">Номер заказа</label>
          <input id="orderNumber" class="form-control form-control-sm" placeholder="можно оставить пустым" />
        </div>
        <div class="mb-2">
          <label class="form-label form-label-sm mb-1">Комментарий</label>
          <textarea id="orderComment" rows="2" class="form-control form-control-sm"></textarea>
        </div>

        <button id="orderSubmit" class="btn btn-primary btn-sm w-100">
          Отправить заказ
        </button>

        <div id="orderStatus" class="small mt-2"></div>
      </div>
    </div>

  </div>
</div>

<script>
  // === БАЗОВЫЕ НАСТРОЙКИ ===
  const API_BASE = '/api';
  const productsCache = new Map();   // id -> product
  let currentProductId = null;

  // --- API helpers ---
  async function apiGet(path) {
    const resp = await fetch(API_BASE + path);
    if (!resp.ok) {
      const text = await resp.text().catch(() => '');
      throw new Error('Ошибка загрузки ' + path + ': ' + resp.status + ' ' + text);
    }
    return resp.json();
  }

  async function apiJson(path, options = {}) {
    const opts = { ...options };
    const headers = opts.headers ? { ...opts.headers } : {};
    if (opts.body && !headers['Content-Type']) {
      headers['Content-Type'] = 'application/json';
    }
    opts.headers = headers;

    const resp = await fetch(API_BASE + path, opts);
    if (!resp.ok) {
      const text = await resp.text().catch(() => '');
      throw new Error('Ошибка ' + path + ': ' + resp.status + ' ' + text);
    }
    const ct = resp.headers.get('content-type') || '';
    if (ct.includes('application/json')) {
      return resp.json();
    }
    return null;
  }

  // === ДЕРЕВО ===
  const treeEl = document.getElementById('productsTree');
  const treeErrorEl = document.getElementById('treeError');

  async function loadTree() {
    treeEl.innerHTML = '<li class="text-muted">Загрузка...</li>';
    treeErrorEl.style.display = 'none';
    try {
      const roots = await apiGet('/products/root');
      treeEl.innerHTML = '';

      if (!roots.length) {
        treeEl.innerHTML = '<li class="text-muted">Дерево пусто.</li>';
        return;
      }

      const assemblies = roots.filter(p => p.type === 'Assembly');
      const others = roots.filter(p => p.type !== 'Assembly');

      assemblies.forEach(p => treeEl.appendChild(createTreeItem(p)));

      if (others.length) {
        const hr = document.createElement('hr');
        hr.className = 'my-1';
        treeEl.appendChild(hr);
        others.forEach(p => treeEl.appendChild(createTreeItem(p)));
      }

    } catch (e) {
      console.error(e);
      treeEl.innerHTML = '';
      treeErrorEl.textContent = 'Ошибка загрузки дерева: ' + e.message;
      treeErrorEl.style.display = 'block';
    }
  }

  function createTreeItem(product) {
    const li = document.createElement('li');

    const row = document.createElement('div');
    row.className = 'tree-item';

    const toggleBtn = document.createElement('span');
    toggleBtn.className = 'tree-toggle';
    toggleBtn.textContent = product.type === 'Assembly' ? '+' : '';
    row.appendChild(toggleBtn);

    const title = document.createElement('span');
    title.className = 'tree-title';
    title.textContent = (product.code || '') + ' — ' + (product.name || '');
    row.appendChild(title);

    const badge = document.createElement('span');
    badge.className = 'badge bg-secondary ms-1 badge-type';
    badge.textContent =
      product.type === 'Assembly' ? 'Сборка' :
      product.type === 'Part' ? 'Деталь' : 'Стандарт';
    row.appendChild(badge);

    li.appendChild(row);

    const childrenUl = document.createElement('ul');
    childrenUl.className = 'tree-children';
    childrenUl.style.display = 'none';
    li.appendChild(childrenUl);

    const hasChildren = product.type === 'Assembly';
    let expanded = false;

    row.addEventListener('click', async (ev) => {
      ev.stopPropagation();
      document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('active'));
      row.classList.add('active');
      currentProductId = product.id;
      await loadProduct(product.id);

      if (hasChildren) {
        if (!expanded) {
          await loadTreeChildren(product.id, childrenUl);
          expanded = true;
          childrenUl.style.display = '';
          toggleBtn.textContent = '-';
        } else {
          if (childrenUl.style.display === 'none') {
            childrenUl.style.display = '';
            toggleBtn.textContent = '-';
          } else {
            childrenUl.style.display = 'none';
            toggleBtn.textContent = '+';
          }
        }
      }
    });

    if (hasChildren) {
      toggleBtn.style.visibility = 'visible';
    } else {
      toggleBtn.style.visibility = 'hidden';
    }

    return li;
  }

  async function loadTreeChildren(parentId, containerUl) {
    containerUl.innerHTML = '<li class="text-muted small">Загрузка...</li>';
    try {
      const children = await apiGet(`/products/${parentId}/children`);
      containerUl.innerHTML = '';
      if (!children.length) {
        containerUl.innerHTML = '<li class="text-muted small">Состав отсутствует.</li>';
        return;
      }
      children.forEach(ch => {
        const prod = {
          id: ch.product_id || ch.id,
          code: ch.code,
          name: ch.name,
          type: ch.type
        };
        containerUl.appendChild(createTreeItem(prod));
      });
    } catch (e) {
      console.error(e);
      containerUl.innerHTML = '<li class="text-danger small">Ошибка загрузки состава.</li>';
    }
  }

  // === КАРТОЧКА ===
  const productHintEl = document.getElementById('productHint');
  const productErrorEl = document.getElementById('productError');
  const productCardEl = document.getElementById('productCard');

  const pCode = document.getElementById('pCode');
  const pName = document.getElementById('pName');
  const pType = document.getElementById('pType');
  const pMass = document.getElementById('pMass');
  const pHeight = document.getElementById('pHeight');
  const pLength = document.getElementById('pLength');
  const pWidth = document.getElementById('pWidth');
  const pVolume = document.getElementById('pVolume');
  const pImage2DContainer = document.getElementById('pImage2DContainer');
  const pModel3DContainer = document.getElementById('pModel3DContainer');
  const btnAddCurrentToCart = document.getElementById('btnAddCurrentToCart');
  const bomBody = document.getElementById('bomBody');

  async function loadProduct(productId) {
    productHintEl.style.display = 'none';
    productErrorEl.style.display = 'none';
    productCardEl.style.display = 'none';

    try {
      let prod = productsCache.get(productId);
      if (!prod) {
        prod = await apiGet(`/products/${productId}`);
        productsCache.set(productId, prod);
      }

      pCode.textContent = prod.code || '—';
      pName.textContent = prod.name || '—';
      pType.textContent =
        prod.type === 'Assembly' ? 'Сборочная единица' :
        prod.type === 'Part' ? 'Деталь' : 'Стандартное изделие';
      pMass.textContent = prod.mass_kg != null ? prod.mass_kg : '—';
      pHeight.textContent = prod.height_mm != null ? prod.height_mm : '—';
      pLength.textContent = prod.length_mm != null ? prod.length_mm : '—';
      pWidth.textContent = prod.width_mm != null ? prod.width_mm : '—';

      const L = Number(prod.length_mm) || 0;
      const W = Number(prod.width_mm) || 0;
      const H = Number(prod.height_mm) || 0;
      const volumeMm3 = L * W * H;
      pVolume.textContent = volumeMm3 ? (volumeMm3 / 1e6).toFixed(3) : '—';

      // 2D картинка
      if (prod.image2d_url) {
        pImage2DContainer.innerHTML =
          `<img src="${prod.image2d_url}" class="img-fluid product-image" alt="2D" />`;
      } else {
        pImage2DContainer.innerHTML = '<div class="small-muted">Не загружено.</div>';
      }

      // 3D модель
      if (prod.model3d_url) {
        pModel3DContainer.innerHTML =
          `<a href="${prod.model3d_url}" target="_blank">Открыть / скачать 3D-модель</a>`;
      } else {
        pModel3DContainer.innerHTML = '<div class="small-muted">Не загружена.</div>';
      }

      productCardEl.style.display = 'block';

      if (prod.type === 'Assembly') {
        await loadBom(prod.id);
      } else {
        bomBody.innerHTML =
          '<tr><td colspan="5" class="text-muted small">Для деталей и стандартных изделий состав не отображается.</td></tr>';
      }

    } catch (e) {
      console.error(e);
      productErrorEl.textContent = 'Ошибка загрузки карточки: ' + e.message;
      productErrorEl.style.display = 'block';
    }
  }

  async function loadBom(parentId) {
    try {
      const items = await apiGet(`/products/${parentId}/children`);
      if (!items.length) {
        bomBody.innerHTML =
          '<tr><td colspan="5" class="text-muted small">Состав пуст.</td></tr>';
        return;
      }
      bomBody.innerHTML = '';
      items.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.code}</td>
          <td>${item.name}</td>
          <td>${item.quantity || 1}</td>
          <td>${
            item.type === 'Assembly' ? 'Сборка' :
            item.type === 'Part' ? 'Деталь' : 'Стандарт'
          }</td>
          <td><button class="btn btn-sm btn-outline-secondary">+</button></td>
        `;
        tr.querySelector('button').addEventListener('click', async () => {
          const id = item.product_id || item.id;
          try {
            await addToCart(id, item.quantity || 1);
          } catch (e) {
            alert('Ошибка добавления в корзину: ' + e.message);
          }
        });
        bomBody.appendChild(tr);
      });
    } catch (e) {
      console.error(e);
      bomBody.innerHTML =
        '<tr><td colspan="5" class="text-danger small">Ошибка загрузки состава.</td></tr>';
    }
  }

  btnAddCurrentToCart.addEventListener('click', async () => {
    if (!currentProductId) {
      alert('Сначала выберите изделие.');
      return;
    }
    try {
      await addToCart(currentProductId, 1);
    } catch (e) {
      alert('Ошибка добавления в корзину: ' + e.message);
    }
  });

  // === КОРЗИНА ===
  const cartBody = document.getElementById('cartBody');
  const cartClearBtn = document.getElementById('cartClear');
  const cartVolumeEl = document.getElementById('cartVolume');

  async function loadCart() {
    try {
      const items = await apiGet('/cart');
      if (!items.length) {
        cartBody.innerHTML =
          '<tr><td colspan="4" class="text-muted small text-center">Корзина пуста.</td></tr>';
        cartVolumeEl.textContent = '0.000';
        return;
      }

      cartBody.innerHTML = '';
      let totalVolumeMm3 = 0;

      items.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.code}</td>
          <td>${item.name}</td>
          <td>${item.quantity}</td>
          <td><button class="btn btn-sm btn-outline-danger">×</button></td>
        `;
        tr.querySelector('button').addEventListener('click', async () => {
          try {
            await removeFromCart(item.id);
          } catch (e) {
            alert('Ошибка удаления из корзины: ' + e.message);
          }
        });
        cartBody.appendChild(tr);

        const L = Number(item.length_mm) || 0;
        const W = Number(item.width_mm) || 0;
        const H = Number(item.height_mm) || 0;
        const q = Number(item.quantity) || 1;
        totalVolumeMm3 += L * W * H * q;
      });

      const totalL = totalVolumeMm3 / 1e6;
      cartVolumeEl.textContent = totalL.toFixed(3);
    } catch (e) {
      console.error(e);
      cartBody.innerHTML =
        '<tr><td colspan="4" class="text-danger small text-center">Ошибка загрузки корзины.</td></tr>';
      cartVolumeEl.textContent = '0.000';
    }
  }

  async function addToCart(productId, quantity = 1) {
    await apiJson('/cart/add', {
      method: 'POST',
      body: JSON.stringify({ productId, quantity })
    });
    await loadCart();
  }

  async function removeFromCart(cartItemId) {
    await apiJson(`/cart/${cartItemId}`, { method: 'DELETE' });
    await loadCart();
  }

  cartClearBtn.addEventListener('click', async () => {
    if (!confirm('Очистить корзину?')) return;
    try {
      await apiJson('/cart/clear', { method: 'DELETE' });
      await loadCart();
    } catch (e) {
      alert('Ошибка очистки корзины: ' + e.message);
    }
  });

  // === ОФОРМЛЕНИЕ ЗАКАЗА ===
  const orderCustomer = document.getElementById('orderCustomer');
  const orderContacts = document.getElementById('orderContacts');
  const orderNumber = document.getElementById('orderNumber');
  const orderComment = document.getElementById('orderComment');
  const orderSubmit = document.getElementById('orderSubmit');
  const orderStatus = document.getElementById('orderStatus');

  orderSubmit.addEventListener('click', async () => {
    const name = orderCustomer.value.trim();
    const contact = orderContacts.value.trim();
    if (!name || !contact) {
      alert('Укажите заказчика и контактные данные.');
      return;
    }

    const body = {
      customer_name: name,
      customer_email: contact.includes('@') ? contact : null,
      customer_phone: !contact.includes('@') ? contact : null,
      order_number: orderNumber.value.trim() || null,
      comment: orderComment.value.trim() || null
    };

    try {
      const resp = await apiJson('/orders', {
        method: 'POST',
        body: JSON.stringify(body)
      });

      orderStatus.textContent =
        `Заказ отправлен. ID: ${resp.order.id}, номер: ${resp.order.order_number || 'не задан'}`;
      orderStatus.className = 'small text-success mt-2';

      orderCustomer.value = '';
      orderContacts.value = '';
      orderNumber.value = '';
      orderComment.value = '';
      await loadCart();
    } catch (e) {
      orderStatus.textContent = 'Ошибка оформления заказа: ' + e.message;
      orderStatus.className = 'small text-danger mt-2';
    }
  });

  // === СТАРТ ===
  (async function init() {
    await loadTree();
    await loadCart();
  })();
</script>

</body>
</html>

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Каталог деталей крана КС-8165 — демо-версия</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      background-color: #f5f5f5;
    }

    header {
      background-color: #212529;
      color: #fff;
    }

    header h1 {
      font-size: 1.4rem;
      margin: 0;
    }

    .tree-panel {
      height: calc(100vh - 120px);
      overflow-y: auto;
      background-color: #fff;
      border-radius: 0.5rem;
      border: 1px solid #dee2e6;
      padding: 0.75rem 0.75rem 1rem;
    }

    .product-panel,
    .cart-panel {
      height: calc(100vh - 120px);
      overflow-y: auto;
      background-color: #fff;
      border-radius: 0.5rem;
      border: 1px solid #dee2e6;
      padding: 0.75rem 0.75rem 1rem;
    }

    ul.tree {
      list-style: none;
      padding-left: 0;
      margin-bottom: 0;
      font-size: 0.9rem;
    }

    ul.tree ul {
      list-style: none;
      padding-left: 1.25rem;
      margin-top: 0.25rem;
    }

    .tree-item {
      white-space: nowrap;
      line-height: 1.4;
    }

    .tree-label {
      cursor: pointer;
    }

    .tree-label:hover {
      text-decoration: underline;
    }

    .tree-toggle-btn {
      width: 1.2rem;
      text-align: center;
      padding: 0;
      border: none;
      background: none;
      cursor: pointer;
      font-weight: 600;
    }

    .tree-toggle-btn:disabled {
      cursor: default;
      color: #ccc;
    }

    .badge-type {
      font-size: 0.7rem;
      vertical-align: middle;
      margin-left: 0.4rem;
    }

    .card-section-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
    }

    .readonly-input {
      background-color: #f8f9fa !important;
    }

    .small-muted {
      font-size: 0.8rem;
      color: #6c757d;
    }
  </style>
</head>
<body>
<header class="py-2 mb-3">
  <div class="container-fluid d-flex justify-content-between align-items-center">
    <div>
      <h1>Каталог деталей крана КС-8165 <span class="text-secondary">— демо-версия</span></h1>
    </div>
    <div class="text-end small text-light">
      Режим просмотра (редактирование доступно только локально)
    </div>
  </div>
</header>

<div class="container-fluid">
  <div class="row g-3">

    <!-- ЛЕВАЯ ПАНЕЛЬ: дерево изделий -->
    <div class="col-12 col-lg-3">
      <div class="tree-panel">
        <div class="mb-2 small">
          Дерево: <strong>сборки → детали → стандартизированные позиции.</strong>
        </div>
        <div id="treeError" class="text-danger small mb-2" style="display:none;"></div>
        <ul id="productsTree" class="tree">
          <li class="text-muted">Загрузка...</li>
        </ul>
      </div>
    </div>

    <!-- СРЕДНЯЯ ПАНЕЛЬ: карточка изделия -->
    <div class="col-12 col-lg-6">
      <div class="product-panel">
        <h5 class="mb-3">Карточка изделия</h5>

        <div id="productHint" class="small-muted mb-2">
          Выберите изделие в дереве слева.
        </div>

        <div class="mb-2">
          <label class="form-label mb-1">Код:</label>
          <input id="prodCode" class="form-control form-control-sm readonly-input" readonly />
        </div>

        <div class="mb-2">
          <label class="form-label mb-1">Наименование:</label>
          <input id="prodName" class="form-control form-control-sm readonly-input" readonly />
        </div>

        <div class="mb-2">
          <label class="form-label mb-1">Тип:</label>
          <input id="prodType" class="form-control form-control-sm readonly-input" readonly />
        </div>

        <div class="row g-2 mb-2">
          <div class="col-6">
            <label class="form-label mb-1">Масса, кг:</label>
            <input id="prodMass" class="form-control form-control-sm readonly-input" readonly />
          </div>
          <div class="col-6 text-end">
            <button id="addToCartBtn" class="btn btn-outline-primary btn-sm mt-4" disabled>
              Добавить в корзину
            </button>
          </div>
        </div>

        <div class="row g-2 mb-3">
          <div class="col-4">
            <label class="form-label mb-1">Длина, мм:</label>
            <input id="prodLen" class="form-control form-control-sm readonly-input" readonly />
          </div>
          <div class="col-4">
            <label class="form-label mb-1">Ширина, мм:</label>
            <input id="prodWidth" class="form-control form-control-sm readonly-input" readonly />
          </div>
          <div class="col-4">
            <label class="form-label mb-1">Высота, мм:</label>
            <input id="prodHeight" class="form-control form-control-sm readonly-input" readonly />
          </div>
        </div>

        <div class="row g-2 mb-3">
          <div class="col-6">
            <div class="card-section-title">2D-изображение</div>
            <div class="border rounded p-2 text-center small-muted">
              2D-изображение ещё не загружено<br />
              (доступно только в локальной админ-версии)
            </div>
          </div>
          <div class="col-6">
            <div class="card-section-title">3D-модель (.glb)</div>
            <div class="border rounded p-2 text-center small-muted">
              3D-модель ещё не загружена<br />
              (доступно только в локальной админ-версии)
            </div>
          </div>
        </div>

        <h6 class="mt-3 mb-2">Состав сборки</h6>
        <div class="small-muted mb-1">
          Для деталей/стандарта состав пуст.
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
            <tr>
              <th style="width: 12%">Код</th>
              <th>Наименование</th>
              <th style="width: 10%">Кол-во</th>
              <th style="width: 12%">Тип</th>
              <th style="width: 12%">В корзину</th>
            </tr>
            </thead>
            <tbody id="bomBody">
            <tr><td colspan="5" class="text-muted small">Выберите сборку в дереве слева.</td></tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>

    <!-- ПРАВАЯ ПАНЕЛЬ: корзина -->
    <div class="col-12 col-lg-3">
      <div class="cart-panel">
        <h5 class="mb-3">Корзина</h5>
        <div class="small-muted mb-1">
          Состав заказа по позициям.
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
            <tr>
              <th style="width: 10%">ID</th>
              <th style="width: 18%">Код</th>
              <th>Наименование</th>
              <th style="width: 15%">Кол-во</th>
              <th style="width: 12%">Удалить</th>
            </tr>
            </thead>
            <tbody id="cartBody">
            <tr><td colspan="5" class="text-muted small">Корзина пуста.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // === БАЗОВЫЕ НАСТРОЙКИ ===
  const API_BASE = 'https://catalog-api-hdqu.onrender.com';

  let productsCache = new Map();   // id -> product
  let currentProductId = null;

  // --- Вспомогательные функции работы с API ---

  async function apiGet(path) {
    const resp = await fetch(API_BASE + path);
    if (!resp.ok) {
      const text = await resp.text().catch(() => '');
      throw new Error('Ошибка загрузки ' + path + ': ' + resp.status + ' ' + text);
    }
    return resp.json();
  }

  async function apiPost(path, body) {
    const resp = await fetch(API_BASE + path, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body || {})
    });
    if (!resp.ok) {
      const text = await resp.text().catch(() => '');
      throw new Error('Ошибка POST ' + path + ': ' + resp.status + ' ' + text);
    }
    return resp.json();
  }

  async function apiDelete(path) {
    const resp = await fetch(API_BASE + path, { method: 'DELETE' });
    if (!resp.ok) {
      const text = await resp.text().catch(() => '');
      throw new Error('Ошибка DELETE ' + path + ': ' + resp.status + ' ' + text);
    }
    return resp.json();
  }

  // --- Дерево изделий ---

  async function loadProductsTree() {
    const treeEl = document.getElementById('productsTree');
    const errorEl = document.getElementById('treeError');

    treeEl.innerHTML = '<li class="text-muted">Загрузка...</li>';
    errorEl.style.display = 'none';

    try {
      const products = await apiGet('/api/products/root');
      productsCache.clear();
      products.forEach(p => productsCache.set(p.id, p));

      const assemblies = products.filter(p => p.type === 'Assembly');
      const others = products.filter(p => p.type !== 'Assembly');

      treeEl.innerHTML = '';

      // сборки
      assemblies.forEach(p => treeEl.appendChild(createTreeItem(p)));

      // отдельный раздел для деталей/стандарта без сборки
      if (others.length) {
        const hr = document.createElement('li');
        hr.className = 'mt-2 mb-1 small text-muted';
        hr.textContent = 'Отдельные детали и стандартизированные позиции:';
        treeEl.appendChild(hr);
        others.forEach(p => treeEl.appendChild(createTreeItem(p)));
      }

    } catch (e) {
      console.error(e);
      treeEl.innerHTML = '';
      errorEl.textContent = 'Ошибка загрузки дерева: ' + e.message;
      errorEl.style.display = 'block';
    }
  }

  function createTreeItem(product) {
    const li = document.createElement('li');
    li.className = 'tree-item';

    const hasChildren = product.type === 'Assembly';

    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'tree-toggle-btn me-1';
    toggleBtn.textContent = hasChildren ? '+' : '•';
    toggleBtn.disabled = !hasChildren;

    const labelBtn = document.createElement('span');
    labelBtn.className = 'tree-label';
    labelBtn.textContent = `${product.code} — ${product.name}`;
    labelBtn.addEventListener('click', () => selectProduct(product.id));

    li.appendChild(toggleBtn);
    li.appendChild(labelBtn);

    const badge = document.createElement('span');
    badge.className = 'badge badge-type';
    if (product.type === 'Assembly') {
      badge.classList.add('bg-primary');
      badge.textContent = 'Сборка';
    } else if (product.type === 'Part') {
      badge.classList.add('bg-success');
      badge.textContent = 'Деталь';
    } else {
      badge.classList.add('bg-warning', 'text-dark');
      badge.textContent = 'Стандартное';
    }
    li.appendChild(badge);

    const childrenUl = document.createElement('ul');
    childrenUl.className = 'tree-children';
    childrenUl.style.display = 'none';
    li.appendChild(childrenUl);

    if (hasChildren) {
      let expanded = false;
      toggleBtn.addEventListener('click', async () => {
        if (!expanded) {
          await loadTreeChildren(product.id, childrenUl);
          expanded = true;
          childrenUl.style.display = 'block';
          toggleBtn.textContent = '–';
        } else {
          const visible = childrenUl.style.display !== 'none';
          childrenUl.style.display = visible ? 'none' : 'block';
          toggleBtn.textContent = visible ? '+' : '–';
        }
      });
    }

    return li;
  }

  async function loadTreeChildren(parentId, containerUl) {
    containerUl.innerHTML = '<li class="text-muted">Загрузка...</li>';
    try {
      const children = await apiGet(`/api/products/${parentId}/children`);
      containerUl.innerHTML = '';
      if (!children.length) {
        containerUl.innerHTML = '<li class="text-muted small">Состав отсутствует.</li>';
        return;
      }
      children.forEach(ch => {
        const prod = {
          id: ch.product_id,
          code: ch.code,
          name: ch.name,
          type: ch.type,
          mass_kg: ch.mass_kg,
          length_mm: ch.length_mm,
          width_mm: ch.width_mm,
          height_mm: ch.height_mm
        };
        productsCache.set(prod.id, prod);
        containerUl.appendChild(createTreeItem(prod));
      });
    } catch (e) {
      console.error(e);
      containerUl.innerHTML =
        '<li class="text-danger small">Ошибка загрузки состава: ' +
        e.message +
        '</li>';
    }
  }

  // --- Карточка изделия и состав сборки ---

  async function selectProduct(productId) {
    currentProductId = productId;
    document.getElementById('addToCartBtn').disabled = false;

    try {
      const prod = await apiGet(`/api/products/${productId}`);

      document.getElementById('productHint').textContent =
        `Код ${prod.code} — ${prod.name}`;

      document.getElementById('prodCode').value = prod.code || '';
      document.getElementById('prodName').value = prod.name || '';
      document.getElementById('prodType').value =
        prod.type === 'Assembly'
          ? 'Сборочная единица'
          : prod.type === 'Part'
          ? 'Деталь'
          : 'Стандартное изделие';

      document.getElementById('prodMass').value =
        prod.mass_kg != null ? String(prod.mass_kg) : '';
      document.getElementById('prodLen').value =
        prod.length_mm != null ? String(prod.length_mm) : '';
      document.getElementById('prodWidth').value =
        prod.width_mm != null ? String(prod.width_mm) : '';
      document.getElementById('prodHeight').value =
        prod.height_mm != null ? String(prod.height_mm) : '';

      if (prod.type === 'Assembly') {
        await loadBom(productId);
      } else {
        const tbody = document.getElementById('bomBody');
        tbody.innerHTML =
          '<tr><td colspan="5" class="text-muted small">Состав есть только у сборок.</td></tr>';
      }
    } catch (e) {
      console.error(e);
      alert('Ошибка загрузки изделия: ' + e.message);
    }
  }

  async function loadBom(parentId) {
    const tbody = document.getElementById('bomBody');
    tbody.innerHTML =
      '<tr><td colspan="5" class="text-muted small">Загрузка состава...</td></tr>';

    try {
      const children = await apiGet(`/api/products/${parentId}/children`);
      if (!children.length) {
        tbody.innerHTML =
          '<tr><td colspan="5" class="text-muted small">Состав пуст.</td></tr>';
        return;
      }

      tbody.innerHTML = '';
      for (const ch of children) {
        const tr = document.createElement('tr');

        const tdCode = document.createElement('td');
        tdCode.textContent = ch.code;
        tr.appendChild(tdCode);

        const tdName = document.createElement('td');
        tdName.textContent = ch.name;
        tr.appendChild(tdName);

        const tdQty = document.createElement('td');
        tdQty.textContent = ch.quantity != null ? String(ch.quantity) : '1';
        tr.appendChild(tdQty);

        const tdType = document.createElement('td');
        tdType.textContent =
          ch.type === 'Assembly'
            ? 'Сборка'
            : ch.type === 'Part'
            ? 'Деталь'
            : 'Стандарт';
        tr.appendChild(tdType);

        const tdCart = document.createElement('td');
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-primary btn-sm';
        btn.textContent = 'В корзину';
        btn.addEventListener('click', () => addToCart(ch.product_id));
        tdCart.appendChild(btn);
        tr.appendChild(tdCart);

        tbody.appendChild(tr);
      }
    } catch (e) {
      console.error(e);
      tbody.innerHTML =
        '<tr><td colspan="5" class="text-danger small">Ошибка загрузки состава: ' +
        e.message +
        '</td></tr>';
    }
  }

  // --- Корзина ---

  async function loadCart() {
    const tbody = document.getElementById('cartBody');
    tbody.innerHTML =
      '<tr><td colspan="5" class="text-muted small">Загрузка...</td></tr>';
    try {
      const items = await apiGet('/api/cart');
      if (!items.length) {
        tbody.innerHTML =
          '<tr><td colspan="5" class="text-muted small">Корзина пуста.</td></tr>';
        return;
      }
      tbody.innerHTML = '';
      for (const it of items) {
        const tr = document.createElement('tr');

        const tdId = document.createElement('td');
        tdId.textContent = it.id;
        tr.appendChild(tdId);

        const tdCode = document.createElement('td');
        tdCode.textContent = it.code;
        tr.appendChild(tdCode);

        const tdName = document.createElement('td');
        tdName.textContent = it.name;
        tr.appendChild(tdName);

        const tdQty = document.createElement('td');
        tdQty.textContent =
          it.quantity != null ? String(it.quantity) : '1';
        tr.appendChild(tdQty);

        const tdDel = document.createElement('td');
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-danger btn-sm';
        btn.textContent = '×';
        btn.addEventListener('click', () => removeFromCart(it.id));
        tdDel.appendChild(btn);
        tr.appendChild(tdDel);

        tbody.appendChild(tr);
      }
    } catch (e) {
      console.error(e);
      tbody.innerHTML =
        '<tr><td colspan="5" class="text-danger small">Ошибка загрузки корзины: ' +
        e.message +
        '</td></tr>';
    }
  }

  async function addToCart(productId) {
    try {
      await apiPost('/api/cart/add', { productId, quantity: 1 });
      await loadCart();
    } catch (e) {
      console.error(e);
      alert('Ошибка добавления в корзину: ' + e.message);
    }
  }

  async function removeFromCart(cartItemId) {
    if (!confirm('Удалить позицию из корзины?')) return;
    try {
      await apiDelete(`/api/cart/${cartItemId}`);
      await loadCart();
    } catch (e) {
      console.error(e);
      alert('Ошибка удаления из корзины: ' + e.message);
    }
  }

  // --- Инициализация ---

  document.addEventListener('DOMContentLoaded', () => {
    loadProductsTree();
    loadCart();

    document.getElementById('addToCartBtn').addEventListener('click', () => {
      if (currentProductId) {
        addToCart(currentProductId);
      }
    });
  });
</script>

</body>
</html>
